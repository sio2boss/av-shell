#!/bin/sh

# Variables
AV_INSTALLED_PATH=/usr/local/lib/node_modules/av

# Figure out where the .av directory is starting with pwd
upsearch () {
  slashes=${PWD//[^\/]/}
  directory="$PWD"
  for (( n=${#slashes}; n>0; --n ))
  do
    test -e "$directory/$1" && export AV_ROOT="$directory/$1" && return
    directory="$directory/.."
  done
}
upsearch ".av"

# Built-in commands
if [[ "$1" == "init" && -z "$AV_ROOT" ]]; then
	echo "This utility creates a new domain specific shell in your current path"
	echo

	echo "your prompt should be named?:"
	read prompt

	echo
	echo "copying files..."
	mkdir .av
	cp -r $AV_INSTALLED_PATH/bin .av/
	cp -r $AV_INSTALLED_PATH/config .av/
	echo "$prompt" > .av/config/prompt

	echo
	echo "done"

	exit
fi

if [ -z "$AV_ROOT" ]; then
	echo "Unable to find av environment, have you run 'av init'?"
	exit
fi


# Handle update command
if [ "$1" == "update" ]; then
	cp -vr $AV_INSTALLED_PATH/bin/* $AV_ROOT/bin/
	cp -rv $AV_INSTALLED_PATH/config/* $AV_ROOT/config/
	exit
fi


# Change dir to script root
cd $AV_ROOT > /dev/null

# If there are arguments, just run them rather than opening a shell
if [ $# -eq 0 ]; then

	# Open shell
	AV_ROOT=$AV_ROOT bash --rcfile $AV_ROOT/config/rc

else

	# Run command in shell
	AV_NON_INTERACTIVE=true AV_ROOT=$AV_ROOT PATH=$AV_ROOT/bin:$PATH bash --rcfile $AV_ROOT/config/rc -i -c "$*"

fi

# Go back
cd - > /dev/null
